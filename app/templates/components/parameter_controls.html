<!-- Parameter Controls Sidebar -->
<div class="parameter-controls-sidebar" id="parameterControlsSidebar">
    <div class="parameter-controls-header">
        <h3>Model Parameters</h3>
        <button class="btn btn-sm btn-outline-secondary close-btn" id="closeParameterControls">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="parameter-controls-content">
        <!-- Presets Section -->
        <div class="presets-section">
            <h4>Presets</h4>
            <div class="presets-list">
                <button class="btn btn-outline-primary preset-btn" data-preset="balanced">
                    <i class="fas fa-balance-scale"></i> Balanced
                </button>
                <button class="btn btn-outline-success preset-btn" data-preset="creative">
                    <i class="fas fa-paint-brush"></i> Creative
                </button>
                <button class="btn btn-outline-info preset-btn" data-preset="precise">
                    <i class="fas fa-bullseye"></i> Precise
                </button>
            </div>
        </div>

        <!-- Parameters Section -->
        <div class="parameters-section">
            <div class="parameter-group">
                <h5>
                    Temperature
                    <span class="parameter-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Controls the randomness of predictions. Higher values make output more random, while lower values make it more deterministic.</span>
                    </span>
                </h5>
                <p class="parameter-description">
                    Controls the randomness of predictions. Higher values make output more random, while lower values make it more deterministic.
                </p>
                <div class="slider-container">
                    <input type="range" min="0.1" max="1.0" step="0.1" value="0.7" class="form-range" id="temperatureSlider">
                    <div class="slider-value">0.7</div>
                </div>
            </div>

            <div class="parameter-group">
                <h5>
                    Top P (Nucleus Sampling)
                    <span class="parameter-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Controls the diversity of the output. Only considers the top P% of tokens with the highest probability. Higher values produce more diverse output.</span>
                    </span>
                </h5>
                <p class="parameter-description">
                    Controls the diversity of the output. Only considers the top P% of tokens with the highest probability.
                </p>
                <div class="slider-container">
                    <input type="range" min="0.0" max="1.0" step="0.05" value="0.95" class="form-range" id="topPSlider">
                    <div class="slider-value">0.95</div>
                </div>
            </div>

            <div class="parameter-group">
                <h5>
                    Top K
                    <span class="parameter-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Controls the diversity of the output. Only considers the top K tokens with the highest probability. Lower values make output more focused.</span>
                    </span>
                </h5>
                <p class="parameter-description">
                    Controls the diversity of the output. Only considers the top K tokens with the highest probability.
                </p>
                <div class="slider-container">
                    <input type="range" min="1" max="50" step="1" value="40" class="form-range" id="topKSlider">
                    <div class="slider-value">40</div>
                </div>
            </div>

            <div class="parameter-group">
                <h5>
                    Repetition Penalty
                    <span class="parameter-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Controls how much the model is penalized for repeating the same tokens. Higher values reduce repetition but may impact fluency.</span>
                    </span>
                </h5>
                <p class="parameter-description">
                    Controls how much the model is penalized for repeating the same tokens. Higher values reduce repetition.
                </p>
                <div class="slider-container">
                    <input type="range" min="1.0" max="2.0" step="0.1" value="1.1" class="form-range" id="repetitionPenaltySlider">
                    <div class="slider-value">1.1</div>
                </div>
            </div>

            <div class="parameter-group">
                <h5>
                    Context Window
                    <span class="parameter-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text">Maximum number of tokens to consider when generating responses. Larger values allow more context to be considered but may slow down responses.</span>
                    </span>
                </h5>
                <p class="parameter-description">
                    Maximum number of tokens to consider when generating responses.
                </p>
                <div class="slider-container">
                    <input type="range" min="512" max="4096" step="128" value="2048" class="form-range" id="contextWindowSlider">
                    <div class="slider-value">2048</div>
                </div>
            </div>
        </div>

        <!-- Save/Reset Section -->
        <div class="controls-section">
            <button class="btn btn-primary" id="saveParameters">
                <i class="fas fa-save"></i> Save Settings
            </button>
            <button class="btn btn-outline-secondary" id="resetParameters">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    </div>
</div>

<style>
/* Custom styles for parameter controls */
.parameter-controls-sidebar {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100%;
    background-color: var(--bg-color);
    box-shadow: -2px 0 10px rgba(0,0,0,0.15);
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
    border-left: 1px solid var(--border-color);
}

.parameter-controls-sidebar.active {
    right: 0;
}

.form-range {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    outline: none;
}

.form-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--primary-color);
    cursor: pointer;
}

.form-range::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border: none;
    border-radius: 50%;
    background: var(--primary-color);
    cursor: pointer;
}

/* Dark mode styles */
body.dark-mode .form-range {
    background: #444;
}
</style>

<!-- Initialize parameter controls -->
<script>
function initParameterControls() {
    const parameterBtn = document.getElementById('parameterControlsBtn');
    const sidebar = document.getElementById('parameterControlsSidebar');
    const closeBtn = document.getElementById('closeParameterControls');
    
    // Parameter elements
    const temperatureSlider = document.getElementById('temperatureSlider');
    const topPSlider = document.getElementById('topPSlider');
    const topKSlider = document.getElementById('topKSlider');
    const repetitionPenaltySlider = document.getElementById('repetitionPenaltySlider');
    const contextWindowSlider = document.getElementById('contextWindowSlider');
    
    // Preset buttons
    const presetButtons = document.querySelectorAll('.preset-btn');
    
    // Save and reset buttons
    const saveBtn = document.getElementById('saveParameters');
    const resetBtn = document.getElementById('resetParameters');
    
    // Toggle sidebar
    parameterBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });
    
    // Close sidebar
    closeBtn.addEventListener('click', () => {
        sidebar.classList.remove('active');
    });
    
    // Initialize sliders
    initializeSliders();
    
    // Apply preset when clicked
    presetButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const preset = btn.dataset.preset;
            applyPreset(preset);
            
            // Update active class
            presetButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
    
    // Save parameters
    saveBtn.addEventListener('click', saveParameters);
    
    // Reset parameters
    resetBtn.addEventListener('click', () => {
        applyPreset('balanced');
        
        // Update active class
        presetButtons.forEach(b => b.classList.remove('active'));
        document.querySelector('[data-preset="balanced"]').classList.add('active');
    });
    
    // Load saved parameters if they exist
    const savedParams = localStorage.getItem('parameters');
    if (savedParams) {
        const params = JSON.parse(savedParams);
        temperatureSlider.value = params.temperature;
        topPSlider.value = params.top_p;
        topKSlider.value = params.top_k;
        repetitionPenaltySlider.value = params.repetition_penalty;
        contextWindowSlider.value = params.context_window;
        
        updateSliderValue(temperatureSlider, params.temperature);
        updateSliderValue(topPSlider, params.top_p);
        updateSliderValue(topKSlider, params.top_k);
        updateSliderValue(repetitionPenaltySlider, params.repetition_penalty);
        updateSliderValue(contextWindowSlider, params.context_window);
        
        updateParameterDisplay(params);
    } else {
        // Default to balanced preset
        applyPreset('balanced');
        document.querySelector('[data-preset="balanced"]').classList.add('active');
    }
}

function initializeSliders() {
    const sliders = document.querySelectorAll('.form-range');
    
    sliders.forEach(slider => {
        const value = slider.nextElementSibling;
        
        // Initialize value display
        updateSliderValue(slider, slider.value);
        
        // Update value display on input
        slider.addEventListener('input', () => {
            updateSliderValue(slider, slider.value);
            
            // Update parameters in real-time
            const key = slider.id.replace('Slider', '');
            updateParameters(key, slider.value);
        });
    });
}

function updateSliderValue(slider, value) {
    const valueDisplay = slider.nextElementSibling;
    valueDisplay.textContent = value;
}

function updateParameters(key, value) {
    // Get current parameters
    let parameters = {};
    if (localStorage.getItem('parameters')) {
        parameters = JSON.parse(localStorage.getItem('parameters'));
    } else {
        // Default parameters
        parameters = {
            temperature: 0.7,
            top_p: 0.95,
            top_k: 40,
            repetition_penalty: 1.1,
            context_window: 2048
        };
    }
    
    // Update parameter
    parameters[key.toLowerCase()] = parseFloat(value);
    
    // Update display
    updateParameterDisplay(parameters);
}

function applyPreset(preset) {
    const temperatureSlider = document.getElementById('temperatureSlider');
    const topPSlider = document.getElementById('topPSlider');
    const topKSlider = document.getElementById('topKSlider');
    const repetitionPenaltySlider = document.getElementById('repetitionPenaltySlider');
    const contextWindowSlider = document.getElementById('contextWindowSlider');
    
    let parameters = {};
    
    switch (preset) {
        case 'balanced':
            parameters = {
                temperature: 0.7,
                top_p: 0.95,
                top_k: 40,
                repetition_penalty: 1.1,
                context_window: 2048
            };
            break;
        case 'creative':
            parameters = {
                temperature: 0.9,
                top_p: 0.95,
                top_k: 50,
                repetition_penalty: 1.0,
                context_window: 2048
            };
            break;
        case 'precise':
            parameters = {
                temperature: 0.3,
                top_p: 0.85,
                top_k: 20,
                repetition_penalty: 1.2,
                context_window: 2048
            };
            break;
    }
    
    // Update sliders
    temperatureSlider.value = parameters.temperature;
    topPSlider.value = parameters.top_p;
    topKSlider.value = parameters.top_k;
    repetitionPenaltySlider.value = parameters.repetition_penalty;
    contextWindowSlider.value = parameters.context_window;
    
    // Update slider values
    updateSliderValue(temperatureSlider, parameters.temperature);
    updateSliderValue(topPSlider, parameters.top_p);
    updateSliderValue(topKSlider, parameters.top_k);
    updateSliderValue(repetitionPenaltySlider, parameters.repetition_penalty);
    updateSliderValue(contextWindowSlider, parameters.context_window);
    
    // Update parameters display
    updateParameterDisplay(parameters);
}

function saveParameters() {
    const temperatureSlider = document.getElementById('temperatureSlider');
    const topPSlider = document.getElementById('topPSlider');
    const topKSlider = document.getElementById('topKSlider');
    const repetitionPenaltySlider = document.getElementById('repetitionPenaltySlider');
    const contextWindowSlider = document.getElementById('contextWindowSlider');
    
    const parameters = {
        temperature: parseFloat(temperatureSlider.value),
        top_p: parseFloat(topPSlider.value),
        top_k: parseInt(topKSlider.value),
        repetition_penalty: parseFloat(repetitionPenaltySlider.value),
        context_window: parseInt(contextWindowSlider.value)
    };
    
    localStorage.setItem('parameters', JSON.stringify(parameters));
    
    // Show save confirmation
    const saveBtn = document.getElementById('saveParameters');
    saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
    saveBtn.classList.remove('btn-primary');
    saveBtn.classList.add('btn-success');
    
    setTimeout(() => {
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Settings';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-primary');
    }, 1500);
}

function updateParameterDisplay(parameters) {
    // Update the parameter display in the chat
    const paramDisplay = document.getElementById('currentParameters');
    if (paramDisplay) {
        paramDisplay.innerHTML = `
            <div>Temp: ${parameters.temperature}</div>
            <div>Top P: ${parameters.top_p}</div>
            <div>Top K: ${parameters.top_k}</div>
        `;
    }
    
    // Save to session storage for API requests
    sessionStorage.setItem('parameters', JSON.stringify(parameters));
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initParameterControls);
</script>
